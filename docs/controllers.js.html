<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="utf-8">
	<title>og docs Source: client/js/controllers.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">og docs</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Config &amp; bootstrap<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/server.html'>server.js (app entry point)</a>
						</li>
						
						<li>
							<a href='/docs/server.config.html'>Server side configurations</a>
						</li>
						
						<li>
							<a href='/docs/url.index.html'>Index of handled URLs</a>
						</li>
						
						<li>
							<a href='/docs/request.handlers.html'>URL handlers</a>
						</li>
						
						<li>
							<a href='/docs/ng.opengash.html'>AngularJS bootstrap</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Node.js modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ogGaApi.html'>ogGaApi</a>
						</li>
						
						<li>
							<a href='/docs/ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ogUtil.html'>ogUtil</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS services<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.service.periods.html'>periods</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.gaApi.html'>gaApi</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.authUrl.html'>authUrl</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS controllers<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.controller.addViewsCtrl.html'>addViewsCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.connectCtrl.html'>connectCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.dashboardCtrl.html'>dashboardCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.mainCtrl.html'>mainCtrl</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: client/js/controllers.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">'use strict';

/**
 * This is the main controller for all pages. Its job is to determine the status of the user:
 * logged in, has saved properties, has access token, etc. Then, load the appropriate template
 * accordingly.
 *
 * @requires $state
 * @requires $cookies
 * @requires ogAccount
 *
 * @namespace ng.controller.mainCtrl
 */
opengash.controller('mainCtrl', [
  '$state', '$cookies', 'ogAccount',
  function ($state, $cookies, ogAccount) {
    if (typeof $cookies.loggedIn !== 'undefined' && typeof $cookies.accessToken !== 'undefined') {
      // User is logged in and has a fresh access token.
      ogAccount.getSavedViews().then(
        function () {
          // GA properties exist. Show them.
          $state.go('dashboard');
        },
        function () {
          // GA properties don't exist. Prompt user to add them.
          $state.go('addViews');
        }
      );
    }
    else {
      // User is not logged in. Display login page.
      $state.go('login');
    }
  }
]);



/**
 * Controls the `connect.html` template. That template only needs a
 * Google OAuth 2.0 URL, and that's what this controller gives it.
 *
 * @requires authUrl
 *
 * @namespace ng.controller.connectCtrl
 */
opengash.controller('connectCtrl', [
  '$scope', 'authUrl',
  function ($scope, authUrl) {
    $scope.authUrl = authUrl;
  }
]);



/**
 * This is the controller for `add-views.html` template.
 *
 * It uses {@link ng.service.ogAccount} to retrieve a all the profiles/views that a user
 * has in Google Analytics in JSON format. The template then displays this information.
 * The controller listens for user interactions with checkboxes.
 *
 * Once the user clicks submit, checked checkboxes are saved to the database and
 * the `dashboard.html` template is loaded using the `$state` service.
 *
 * @requires ogAccount
 * @requires $state
 *
 * @namespace ng.controller.addViewsCtrl
 */
opengash.controller('addViewsCtrl', [
  '$scope', 'ogAccount', '$state',
  function ($scope, ogAccount, $state) {

    $scope.allViews = ogAccount.getAllViews();
    $scope.selectedViews = [];

    $scope.updateSelection = function ($event, view) {
      if ($event.target.checked && $scope.selectedViews.indexOf(view) === -1) {
        $scope.selectedViews.push(view);
      }
      if (!$event.target.checked && $scope.selectedViews.indexOf(view) !== -1) {
        $scope.selectedViews.splice($scope.selectedViews.indexOf(view), 1);
      }
    };

    $scope.saveSelectedViews = function () {
      ogAccount.saveViews($scope.selectedViews);
      $state.go('dashboard');
    };
  }
]);

/**
 * This is the monster that displays the main dashboard.
 * It needs a lot of clean up.
 *
 * @requires $scope
 * @requires gaApi
 * @requires ogAccount
 * @requires $timeout
 * @requires periods
 * @requires $sce
 *
 * @namespace ng.controller.dashboardCtrl
 */
opengash.controller('dashboardCtrl', [
  '$scope', 'gaApi', 'ogAccount', '$timeout', 'periods', '$sce',
  function ($scope, gaApi, ogAccount, $timeout, periods, $sce) {

    ogAccount.getSavedViews().then(function (arrViews) {

      // Initialize stuff.
      var arrIds = arrViews.map(function (view) {
          return 'ga:' + view.id;
        }),
        strMetrics = 'ga:visitors,ga:pageviews,ga:pageviewsPerVisit,ga:avgTimeOnSite,ga:visitBounceRate,ga:percentNewVisits,ga:avgPageLoadTime',
        numApiCallsNeeded = periods.totalPeriods * arrIds.length,
        executionDelay = 0,
        tableContentConstructor,
        apiCallsCounter = 0;

      $scope.tableStructure = { metrics: strMetrics.replace(/ga:/g, '').split(','), views: arrIds, periods: periods.ordered };
      $scope.tableContent = {};
      $scope.tableComparisonContent = {};

      tableContentConstructor = function (id, period, startDate, endDate, comparison) {
        return function () {

          gaApi.getReport(id, startDate, endDate, strMetrics).then(function (results) {

            if (!comparison) {
              if (typeof $scope.tableContent[results.profileInfo.tableId] == 'undefined')
                $scope.tableContent[results.profileInfo.tableId] = {};

              $scope.tableContent[results.profileInfo.tableId][period] = results;
            }
            else {
              if (typeof $scope.tableComparisonContent[results.profileInfo.tableId] == 'undefined')
                $scope.tableComparisonContent[results.profileInfo.tableId] = {};

              $scope.tableComparisonContent[results.profileInfo.tableId][period] = results;
            }

            // TODO: Use promises for control-flow instead
            apiCallsCounter++;
            if (apiCallsCounter == numApiCallsNeeded) {
              // All needed API results have been received. Do stuff with it here.
              // Calculate metric movements.
              $scope.movement = angular.copy($scope.tableComparisonContent);
              periods.forEach(arrIds, function (id, period) {
                var arrMetrics = strMetrics.split(',');
                var contentResult, comparisonContentResult, movementContent, movementPercentage;

                for (var metricsIndex = 0; metricsIndex &lt; arrMetrics.length; metricsIndex++) {
                  if (period != 'today') {
                    contentResult = $scope.tableContent[id][period]['totalsForAllResults'][arrMetrics[metricsIndex]],
                      comparisonContentResult = $scope.tableComparisonContent[id][period]['totalsForAllResults'][arrMetrics[metricsIndex]];
                    movementPercentage = parseFloat((((contentResult - comparisonContentResult) / contentResult) * 100).toFixed(1));
                    movementContent = movementPercentage + '%';
                    if (movementPercentage > 0) {
                      movementContent = '&lt;span class="text-success">' + movementContent + '&lt;/span>';
                    }
                    else {
                      movementContent = '&lt;span class="text-danger">' + movementContent + '&lt;/span>';
                    }

                    $scope.movement[id][period]['totalsForAllResults'][arrMetrics[metricsIndex]] = $sce.trustAsHtml(movementContent);
                  }
                }
              });
            }
          });
        }
      }

      periods.forEach(arrIds, function (id, period) {
        // Get original content
        $timeout(
          tableContentConstructor(id, period, periods.dates[period].start, periods.dates[period].end, false),
          executionDelay
        );
        executionDelay += 150;

        // Get comparison content
        if (period != 'today') {
          $timeout(
            tableContentConstructor(id, period, periods.comparisonDates[period].start, periods.comparisonDates[period].end, true),
            executionDelay
          );
          executionDelay += 150;
        }
      });
    });
  }
]);</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Sun Sep 08 2013 19:10:59 GMT+0300 (AST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
