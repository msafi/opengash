<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="utf-8">
	<title>og docs Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">og docs</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Config &amp; bootstrap<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/server.html'>server.js (app entry point)</a>
						</li>
						
						<li>
							<a href='/docs/server.config.html'>Server side configurations</a>
						</li>
						
						<li>
							<a href='/docs/url.index.html'>Index of handled URLs</a>
						</li>
						
						<li>
							<a href='/docs/request.handlers.html'>URL handlers</a>
						</li>
						
						<li>
							<a href='/docs/ng.opengash.html'>AngularJS bootstrap</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Node.js modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ogGaApi.html'>ogGaApi</a>
						</li>
						
						<li>
							<a href='/docs/ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ogUtil.html'>ogUtil</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS services<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.service.periods.html'>periods</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.gaApi.html'>gaApi</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.authUrl.html'>authUrl</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS controllers<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.controller.addViewsCtrl.html'>addViewsCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.connectCtrl.html'>connectCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.dashboardCtrl.html'>dashboardCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.mainCtrl.html'>mainCtrl</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
		<div class="span8">
			
				<div id="main">
					


	
	<span class="page-title">Index</span>
	
	












	
	





    <section>
        <article><h1>opengash documentation</h1>
<p>These docs should help you better understand how opengash functions in the background.</p>
<p>You are not expected to read this document in one go. You are expected to go back and forth between this document, the project's source code, a running opengash app, and Google.</p>
<h2>Initial setup</h2>
<p>The steps for the initial setup are described on <a href="https://github.com/msafi/opengash">GitHub README</a> file.</p>
<h2>Technical overview</h2>
<p>Assuming you have everything setup and ready, here's a technical rundown of how things flow in opengash.</p>
<h3>When a user requests the homepage, <code>/</code></h3>
<p>At the time of this writing, the only user-facing URL that opengash has is the root, <code>/</code>, URL. When a user requests that URL, the first thing opengash does is put this request through a series of middleware found in <a href="server.html">server</a>.</p>
<h4>CSRF</h4>
<p>One of these middleware is <a href="ogUtil.html#csrf">ogUtil.csrf</a>, which sets cookie with a unique identifier in the user's browser. Every subsequent requests the user make to opengash get checked against this unique identifier. This prevents cross-site request forgeries.</p>
<h4>Routes</h4>
<p>After that, <a href="url.index.html">url.index</a> determines which URL handler handles the request. Since users only make requests to <code>/</code>, the handler is always <a href="request.handlers.html#home">request.handlers.home</a>.</p>
<p>In most cases, this handler will simply serve the request with the <code>index.ejs</code> template. Effectively handing over control of the application to the front-end, where AngularJS reigns supreme. </p>
<p>Now the server just waits for JSON API requests from Angular.</p>
<h3>On the front-side</h3>
<p>Once <code>index.ejs</code> gets loaded on the front-end, the AngularJS opengash app gets bootstrapped and started using <a href="ng.opengash.html">app.js</a>. It configures AngularJS's <code>$stateProvider</code> and <code>$locationProvider</code>.</p>
<p>After that <a href="ng.controller.mainCtrl.html">ng.controller.mainCtrl</a> gets fired.</p>
<p><code>mainCtrl</code>, seeing that this is a new user, loads the <code>connect.html</code> template. This template, in turn, is controlled by <a href="ng.controller.connectCtrl.html">ng.controller.connectCtrl</a>.</p>
<p><code>connectCtrl</code> contacts the server to request a Google OAuth 2.0 login URL. <code>connect.html</code> links to this URL in a big red button that says <em>Connect to Google</em>.</p>
<h3>The user goes to Google</h3>
<p>When the user clicks on the red button, they get sent to Google where they should click <em>Accept</em> to give opengash permission to use their Google Analytics data.</p>
<p>When the user clicks <em>Accept</em>, Google redirects them to the <code>redirectUrl</code> that you specified in your <code>config.js</code>. The user doesn't see anything specific to this URL when they get redirected to it. It does it's work in the background.</p>
<p>The <code>redirectUrl</code> is handled by <a href="request.handlers.html#authenticate">request.handlers.authenticate</a>. This function first verifies that the user has a valid CSRF using <a href="ogUtil.html#verifyCsrf">ogUtil.verifyCsrf</a>. Then, it finishes up the authentication process with Google using ogGaApi.requestAccessToken. Once the user has been fully authenticated, the handler sends an API request, using ogGaApi.call, in order to retrieve the user's basic info: name, email, profile image, etc.</p>
<p>With that information, the handler uses <a href="ogAccount.html#saveUser">ogAccount.saveUser</a> to save the user in the database.</p>
<p>Finally, the handler sets a cookie marking this user as <em>logged in</em>, sets another cookie with Google API access token, and silently redirects the user to the homepage. </p>
<p>All of this happens in the background without the user's involvement.</p>
<h3>After authentication, the user comes back to the homepage</h3>
<p>So, having been fully authenticated, the user is redirected back to the homepage from <code>redirectUrl</code>. </p>
<p><a href="ng.controller.mainCtrl.html">ng.controller.mainCtrl</a> sees the user again, but this time it sees that the user has a login cookie and a fresh access token from Google. That means AngularJS can use this token to retrieve user information directly from Google. But since the user hasn't yet selected which Google Analytics profiles they would like to see on opengash dashboard, they will be presented with a screen that prompts them to select those profiles. That screen is the template <code>add-views.html</code>.</p>
<h3>User selects Google Analytics profiles to add to opengash</h3>
<p><em>Note: Google Analytics has recently switched from the term <code>profile</code> to <code>views</code>. So, these two terms are used interchangeably on opengash.</em></p>
<p>Once this template is loaded, its controller <a href="ng.controller.addViewsCtrl.html"><code>addViewsCtrl</code></a> kicks in. Using <a href="ng.service.ogAccount.html">ng.service.ogAccount</a>, this controller retrieves a list of all the profiles that the user has under their Google Analytics account. These profiles are then displayed using <code>add-views.html</code>. The user checks the ones they like to add and click submit. Using <a href="ng.service.ogAccount.html">ng.service.ogAccount</a> again, the <em>Submit</em> button sends the profiles to the server where they get saved and now the <code>dashboard.html</code> template gets loaded.</p>
<h3>The dashboard</h3>
<p>The dashboard is where the fruits of all of this labor get consumed. The user now has a log in cookie, an access token cookie, and a saved list of Google Analytics profiles.</p>
<p>The dashboard is displayed using <code>dashboard.html</code> template, which is controlled by <a href="ng.controller.dashboardCtrl.html">ng.controller.dashboardCtrl</a>. <code>dashboardCtrl</code> uses several AngularJS services: <a href="ng.service.gaApi.html">ng.service.gaApi</a>, <a href="ng.service.ogAccount.html">ng.service.ogAccount</a>, and <a href="ng.service.periods.html">ng.service.periods</a> to construct parsed JSON objects, which the template uses to make the opengash tables.</p>
<hr>
<p>If you need more clarifications about anything, submit an issue at <a href="https://github.com/msafi/opengash">opengash's GitHub</a> page.</p></article>
    </section>







				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Sun Sep 08 2013 19:10:59 GMT+0300 (AST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<div class="span3">
				<div id="toc"></div>
			</div>
			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>