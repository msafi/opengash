<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="utf-8">
	<title>og docs Source: server/ogUtil.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">og docs</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Config &amp; bootstrap<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/server.html'>server.js (app entry point)</a>
						</li>
						
						<li>
							<a href='/docs/server.config.html'>Server side configurations</a>
						</li>
						
						<li>
							<a href='/docs/url.index.html'>Index of handled URLs</a>
						</li>
						
						<li>
							<a href='/docs/request.handlers.html'>URL handlers</a>
						</li>
						
						<li>
							<a href='/docs/ng.opengash.html'>AngularJS bootstrap</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Node.js modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ogGaApi.html'>ogGaApi</a>
						</li>
						
						<li>
							<a href='/docs/ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ogUtil.html'>ogUtil</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS services<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.service.periods.html'>periods</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.gaApi.html'>gaApi</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.authUrl.html'>authUrl</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS controllers<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.controller.addViewsCtrl.html'>addViewsCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.connectCtrl.html'>connectCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.dashboardCtrl.html'>dashboardCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.mainCtrl.html'>mainCtrl</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: server/ogUtil.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/**
 * Miscellaneous utilities and helper functions for opengash app
 * @namespace ogUtil
 */

var express = require('express'),
    qs = require('querystring');

/**
 * Augments express.response (aka Node.js response) object. This function automatically
 * determines whether to respond with a template and JSON data or just a JSON based
 * on the request URL.
 * @function ogUtil.ogRender
 *
 * @param arg1 {object|string} This can either be a JSON object to be sent to the
 * browser. Or a template name for when the browser should respond with an HTML
 * file.
 *
 * @param [arg2] {object} This is used to provide data in a JSON format
 * when `arg1` is a template name.
 */
module.exports = express.response.ogRender = function (arg1, arg2) {

  if (this.req.path.substr(1, 3) == 'api' && this.req.path.substr(-4, 4) == 'json') {
    // API call. Send JSON.
    this.req.res.json(arg1);
  }
  else {
    // Human request
    this.req.res.render(arg1, arg2); // arg1 = template. arg2 = JSON data.
  }
};



/**
 * A middleware that sets a cookie of a randomly generated UID value.
 * @function ogUtil.csrf
 *
 * @param req {object} express framework request object
 * @param res {object} express framework response object
 * @param next {object} the next function in the middleware chain
 */
module.exports.csrf = function (req, res, next) {
  if (typeof req.cookies.csrf === 'undefined') {
    var uid = function () {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    res.cookie('csrf', uid(), {maxAge: 631138519494}); // 20 years in milliseconds.
  }
  next();
};


/**
 * This function is used at the beginning of each request handler ({@link request.handlers})
 * to verify that the request contains a valid anti cross site request forgery token.
 *
 * It looks for a CSRF in the request query and compares it with the value of the CSRF
 * token in the cookies. If a match is found, things continue. Otherwise the process
 * gets aborted prematurely.
 *
 * @example
 * ```
 * ogUtil.verifyCsrf();
 * ```
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function ogUtil.verifyCsrf
 */
module.exports.verifyCsrf = function (req, res) {
  var sourcesOfCsrf = [qs.parse(req.query.state).csrf, req.query.csrf];

  if (sourcesOfCsrf.indexOf(req.cookies.csrf) == -1) {
    res.send(401, 'Unable to authorize. Make sure you accept cookies.');
  }
};</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Sun Sep 08 2013 19:10:59 GMT+0300 (AST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
