<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="utf-8">
	<title>og docs Source: server/routes/handlers.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">og docs</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Config &amp; bootstrap<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/server.html'>server.js (app entry point)</a>
						</li>
						
						<li>
							<a href='/docs/server.config.html'>Server side configurations</a>
						</li>
						
						<li>
							<a href='/docs/url.index.html'>Index of handled URLs</a>
						</li>
						
						<li>
							<a href='/docs/request.handlers.html'>URL handlers</a>
						</li>
						
						<li>
							<a href='/docs/ng.opengash.html'>AngularJS bootstrap</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Node.js modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ogGaApi.html'>ogGaApi</a>
						</li>
						
						<li>
							<a href='/docs/ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ogUtil.html'>ogUtil</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS services<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.service.periods.html'>periods</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.gaApi.html'>gaApi</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.authUrl.html'>authUrl</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS controllers<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.controller.addViewsCtrl.html'>addViewsCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.connectCtrl.html'>connectCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.dashboardCtrl.html'>dashboardCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.mainCtrl.html'>mainCtrl</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: server/routes/handlers.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/**
 * The functions that handle incoming requests.
 *
 * Each function is assigned to a URL by {@link urls.index}
 *
 * @namespace request.handlers
 */

var OgGaApi = require('../ogGaApi'),
    config = require('../config'),
    verifyCsrf = require('../ogUtil').verifyCsrf,
    OgAccount = require('../ogAccount');

var ogGaApi = new OgGaApi(config.clientId, config.clientSecret, config.redirectUrl);



/**
 * Handles requests to root URL '/'
 *
 * If the user has a loggedIn cookie **but** an expired Google API access token, he is
 * automatically forwarded to Google to grant permission to opengash. In all other cases,
 * `index.ejs` is served. From there, AngularJS {@link controllers.mainCtrl} on the
 * front-end determines what to display on the homepage.
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function request.handlers.home
 */
exports.home = function (req, res) {
  if (typeof req.signedCookies.loggedIn !== 'undefined' && typeof req.cookies.accessToken === 'undefined') {
    // User is logged in, but has an expired token. Redirect to authentication URL silently.
    res.redirect(307, ogGaApi.url(req.cookies.csrf));
  }
  else {
    res.ogRender('index');
  }
};



/**
 * Handles requests to the URL that you specify as your Google API redirect URL
 * in {@link server.config}.
 *
 * When Google forwards your visitor to this URL, first an access token is
 * requested using {@link ogGaApi#requestAccessToken}. Using this access token,
 * an API call is made to Google using {@link ogGaApi#call} to get the visitor's
 * basic info, i.e. email, name, profile picture URL, etc.
 *
 * Upon the success of that call, {@link ogAccount.saveUser} is used to save the
 * user to the database. And when that succeeds, two cookies are given to the
 * user.
 *
 * 1. `loggedIn` to mark them as logged in. It lasts for 20 years.
 * 2. `accessToken` which is used to make further requests to the visitor's Google account.
 * This one lasts one hour only though because that's how long an access token is valid for.
 *
 * Finally, the user is redirected to the homepage with status of 302. Meaning `found`, I think.
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function request.handlers.authenticate
 */
exports.authenticate = function (req, res) {

  verifyCsrf(req, res);

  ogGaApi.requestAccessToken(req.query.code, function (err, _res, body) {
    // Get user basic information.
    var accessToken = JSON.parse(body);

    var url = 'https://www.googleapis.com/oauth2/v1/userinfo';
    ogGaApi.call(accessToken.access_token, url, function (err, _res, body) {
      var user = JSON.parse(body);
      user.id = parseInt(user.id);
      user.verified_email = (user.verified_email) ? 1 : 0;

      // Find a user in the database by their ID and upsert.
      OgAccount.saveUser(user, function (err, _results) {
        if (err)
          res.end(i(err));

        res.cookie('loggedIn', user.email, {maxAge: 631138519494, signed: true}); // 20 years in milliseconds.
        res.cookie('accessToken', accessToken.access_token, {maxAge: accessToken.expires_in * 1000});
        res.redirect(302, '/');
      });
    });
  });
};



/**
 * This is an API request handler. It provides a JSON response containing
 * a Google OAuth 2.0 compatible URL using {@link ogGaApi#url}.
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function request.handlers.authUrl
 */
exports.authUrl = function (req, res) {
  var data = {
    url: ogGaApi.url(req.cookies.csrf)
  }
  res.ogRender(data);
}



/**
 * This is an API request handler. It looks for value of `loggedIn` cookie, which contains
 * the email of the logged in user. Then it uses that email to see if the user had
 * previously saved his Google Analytics profiles (aka views). If found,
 * the views are returned. Otherwise, an empty response is returned. The empty response
 * evaluates to false on the front-end, at {@link services.ogAccount} for example.
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function request.handlers.gaViews
 */
exports.gaViews = function (req, res) {
  verifyCsrf(req, res);
  var userEmail = req.signedCookies.loggedIn;
  OgAccount.getGaViews(userEmail, function (gaViews) {

    if (gaViews) {
      res.ogRender(gaViews);
    }
    else {
      res.end('');
    }
  });
}



/**
 * This handler accepts a POST request. The POST is expected to carry
 * a JSON formatted array of views. The views are saved to the database
 * using {@link ogAccount.saveViews}. The user submitting this request
 * is identified by his `loggedIn` cookie, which has his email as its value.
 *
 * @param req {object} Node.js/express request object
 * @param res {object} Node.js/express response object
 *
 * @function request.handlers.gaSaveViews
 */
exports.gaSaveViews = function (req, res) {
  verifyCsrf(req, res);
  var userEmail = req.signedCookies.loggedIn;
  OgAccount.saveViews(userEmail, req.body);
}</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Sun Sep 08 2013 19:10:59 GMT+0300 (AST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
