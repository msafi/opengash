<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="utf-8">
	<title>og docs Source: server/ogAccount.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">og docs</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Config &amp; bootstrap<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/server.html'>server.js (app entry point)</a>
						</li>
						
						<li>
							<a href='/docs/server.config.html'>Server side configurations</a>
						</li>
						
						<li>
							<a href='/docs/url.index.html'>Index of handled URLs</a>
						</li>
						
						<li>
							<a href='/docs/request.handlers.html'>URL handlers</a>
						</li>
						
						<li>
							<a href='/docs/ng.opengash.html'>AngularJS bootstrap</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">Node.js modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ogGaApi.html'>ogGaApi</a>
						</li>
						
						<li>
							<a href='/docs/ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ogUtil.html'>ogUtil</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS services<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.service.periods.html'>periods</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.ogAccount.html'>ogAccount</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.gaApi.html'>gaApi</a>
						</li>
						
						<li>
							<a href='/docs/ng.service.authUrl.html'>authUrl</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="" class="dropdown-toggle" data-toggle="dropdown">AngularJS controllers<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href='/docs/ng.controller.addViewsCtrl.html'>addViewsCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.connectCtrl.html'>connectCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.dashboardCtrl.html'>dashboardCtrl</a>
						</li>
						
						<li>
							<a href='/docs/ng.controller.mainCtrl.html'>mainCtrl</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: server/ogAccount.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/**
 * Provides the database functions to CRUD opengash accounts.
 *
 * To get an idea of what the schema might look like, see SCHEMA.md in the `docs/static` folder.
 *
 * @namespace ogAccount
 */



var MongoClient = require('mongodb').MongoClient;
var async = require('async');
var config = require('./config');



/**
 * A helper function that:
 *
 * 1. Opens a database connection
 * 2. Executes the callback function
 * 3. Closes the database connection.
 *
 * To ensure flow-control, it uses Node.js async module.
 *
 * See other functions in this module for how it is used.
 *
 * @param callback {function} The function to be executed upon connecting to the database.
 *
 * @function ogAccount.connect
 */
var connect = function (callback) {
  MongoClient.connect(config.dbUri, function (err, ogDb) {
    async.series([
      function () {
        callback(err, ogDb);
      },
      function () {
        ogDb.close();
      }
    ]);
  });
}



/**
 * Saves a parsed JSON object, `user`, to the database. Then, executes a callback function.
 *
 * It uses `user.id` to find out if the record already exists in the database. If so, it updates it.
 * If the record isn't found, a new record is created.
 *
 * @param user {object} a parsed JSON object.
 * @param callback {function} a function to be executed upon success or failure.
 *
 * @function ogAccount.saveUser
 */
module.exports.saveUser = function (user, callback) {
  connect(function (err, ogDb) {
    if (err) {
      callback(err);
    }
    else {
      ogDb.collection('ogAccount').update({"user.id": user.id}, {$set: {user: user}}, {upsert: true}, function (err, results) {
        callback(err, results);
      });
    }
  });
}


/**
 * Retrieves the Google Analytics profiles, aka views, of a user and passes the results array to a callback function.
 *
 * The results array looks like:
 *
 * ```
 * [{"Property Name", "id:12345678"}]
 * ```
 *
 * @param email {string} the user email string to query the database
 * @param callback {function} a callback function to do something with the returned results.
 *
 * @function ogAccount.getGaViews
 */
module.exports.getGaViews = function (email, callback) {
  connect(function (err, ogDb) {
    ogDb.collection('ogAccount').findOne({"user.email": email}, function (err, ogAccount) {
      try {
        var gaViews = ogAccount.gaViews;
        callback(gaViews, err);
      }
      catch (e) {
        callback(null, err);
      }
    });
  });
}



/**
 * Saves a user's selected views to the database. It finds the user by the provided email.
 *
 * The views are saved as an array of parsed JSON objects under the field `gaViews`.
 *
 * @param email {string} search query
 * @param views {object} parsed JSON object
 * @param callback {function} function to let you do something with the results.
 *
 * @function ogAccount.saveViews
 */
module.exports.saveViews = function (email, views, callback) {
  connect(function (err, ogDb) {
    ogDb.collection('ogAccount').update({"user.email": email}, {$set: {gaViews: views}}, function (err, results) {
      callback(err, results);
    });
  });
}</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Sun Sep 08 2013 19:10:59 GMT+0300 (AST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
